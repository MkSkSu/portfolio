# 【ノンコード】自作したbotを企業向けTeamsアプリにしたかった話【目標未達】

## 導入 
社内向けのプロジェクトで、社内向けにbotサービスを作れないかという話が出た。要件は下記の通り。
* Azure bot Serviceを利用したbotを作りたい
* Teamsで利用したい
二日間の調査期間と諸々のアカウントを渡された私たちのチームは、このような調査結果を得た。
* Azure QnA を利用することでQ&Aの質疑応答内容(KB)が作成できる
* Azure QnA と Azure bot Service をつなげることで質問内容を登録したbotが作成できる
* Azure bot Service から色々なサービスにbotを公開でき、その中にはもちろんTeamsも含まれる

だが、実際にbotを作成するところまではできなかった...なので、夏休み期間で個人的にやってみた。

## 参考資料
下記リンクの記事を参考にさせていただきました。やってることはほぼ同じですので、HowToが知りたい方はリンク先の記事を参照された方が早いかもです。
https://qiita.com/Taiga_san/items/1c68ec5f998a7a00a6a6
https://qiita.com/chomado/items/6bda10abde0551f25723

## 実際にやったこと【概要】
### bot作成 【成功】
1. Azure QnAのリソースとKBを作成
2. Azure QnA側から(重要) Azure bot Serviceのリソースを作成
### Teams動作確認 【成功】
3. Azure bot ServiceでTeamsのチャンネルを開設
4. Teamsで動作確認
### 自企業向けアプリとして公開【失敗】
5. Teamsのアプリ公開設定を作成して、管理者に自企業向けアプリとして公開申請
6. 管理者サイトで自企業向けアプリとして承認＆公開
6. Teamsで公開されたアプリをインストール

## bot作成 【成功】までの手順
### 1. Azure QnAのリソースとKBを作成
ホーム > リソースの作成 からQnA Makerを選択して、入力項目を入力すると、リソースを作成できます。
* 検索画面
![皆様ご存知QnA](画像\1.リソースの作成.png)
### 2. KBの作成
リソースのデプロイが完了すると、下記の画像のような画面になります。*リソースに移動*を押下しましょう。
* デプロイ完了後の画面
![デプロイ完了](画像\3.しばらく待つとデプロイ完了になる.png)
チュートリアルが表示されます。2 に表示されている *QnA Maker ポータル* のリンクをクリックしましょう。
![チュートリアルの表示](画像\4.リソースに移動したら、ポータルをクリックする.png)
QnA Maker ポータルではKB(質疑応答データ的なもの)を作成します。
1のSTEP は飛ばして、2のSTEP で先ほど作成したリソースを選択しましょう。
![冒頭の注意事項1/2](画像\5.ポータルで色々入力する.png)
STEP 3はKB自体の名前です。自由に入力しましょう。注意すべきはSTEP 4。こちらは質疑応答内容の値を登録するSTEPです。URL入力、Excelデータ他ファイル形式をインポート等々で初期値を設定できます。
また、*chit-chat* というラジオボタンの項目でnone以外を選択すると、選択した項目の性格に合わせてデフォルトで用意された質疑応答データがインポートされます。こちらは特に理由がない限りnoneを選択することをお勧めします。
理由は、質疑応答の容量がQnA Maker 作成時に設定したリソースの料金によって決まっているからです。
無料枠を利用している場合、下手すると一問もオリジナルの質疑応答データを追加できなくなります...(筆者はここで数十分悩みました)
![注意事項2/2](画像\補足_1_noneに設定しないと容量不足になる.png)
KB作成フォームの入力内容が問題なければ、KBが作成されます。こちらの*EDIT* タブでインポートされた質疑応答内容が確認できます。データの追加や、MarkDown形式等で質疑応答内容の書式設定をすることもできるようです。
![KB作成](画像\7.問題なければ制作される.png)
内容に問題がなければ、*PUBLISH* を押下しましょう。ポップアップ画面から公開を選ぶとこのようにKBの公開が成功したこと、次何する?といったことが聞かれます。ここまでで一章の内容は完了になります。
### 3. Azure QnA側から(重要) Azure bot Serviceのリソースを作成
作成したQnAのKBを公開したら、*Create Bot*を選択しましょう。
![KBの公開](画像\9.公開が成功すると次に何をするか聞かれる.png)
そうすると、Azure bot Serviceのリソース作成画面に移動します。リソースの作成画面では、既にQnAとの接続情報が入力されています。
既に入力されている箇所には手を触れず、リソースの名前等空欄の部分を埋めてリソースを作成しましょう。
![Azure bot Service リソース作成画面](画像\10.createbotボタンを押すと設定値が大半入力された状態のAzureBotServiceが開かれる.png)
※ ここから先、前の画像と表示されているリソース名が異なります。手順には関係ないためご容赦ください。

入力項目を埋めてデプロイするとAzure bot Serviceに必要な諸々がデプロイされます。その中から、*Webアプリ bot* と表示されたリソースの詳細を見ましょう。設定> Web チャットでテスト をクリックしてしばらく待つと、"Hello and welcome" 等々歓迎のあいさつが出力されます。出力内容は初期値の言語によるらしいです。5分ほど待っても何も入力されない場合、QnA Maker との接続がうまくいっていないことが考えられます。
QnA Maker のKBから Azure bot Service を作成したのであれば問題ないはずなのですが、どこかで値をいじってしまったのかもしれません。*3. Azure QnA側から(重要) Azure bot Serviceのリソースを作成* からやり直してみてください。
![リソースの作成が完了](画像\13.Webアプリ_ボットのリソース詳細からWebチャットでテストをクリック、少し待つと応答が来る.png)

"Hello and welcome" 等々歓迎のあいさつが出力された時点で、QnA Maker との接続は完了しています。
*メッセージを入力してください* の箇所に文言を入力、送信ボタンを押下するとQnA Maker から返答が返されます。
![Azure bot Service による動作確認](画像\14.ここでbotの回答の動作確認ができる.png)

## Teams動作確認 【成功】までの手順
### 4. teamsのチャンネルを作成
 チャンネル から Teamsのチャンネルを作成できます。
 入力項目は少ないので、すべてデフォルトで作成しましょう。
 また、ラジオボタン下の項目*前略) Gorvernment* を選択すると、次の作業でbotから返信が返されない不具合が発生しました。理由は不明です。
 * 作成したチャンネルは、このように確認できます。
 ![チャンネルを作成できた](画像\補足_3_作成したチャンネル.png)
 チャンネルを生成できたら、*Microsoft Teams*がリンクになっていることに気づくかもしれません。クリックしましょう。
 すると、Teamsが開かれます(Web ブラウザーでワンクッション挟むかもしれません)
 開かれたチャネルで、動作確認ができます。Azure bot Serviceの Web チャットでテスト と同じように、botと接続しての応答が可能です。
 ![チャンネルを作成したタイミングでの動作確認](画像\補足_2_チャンネルを作成したタイミングでの動作確認が可能.png)

## 自企業向けアプリとして公開【失敗】
この先失敗しているため、詳細な設定値などには触れずにmanifestの作成方法について紹介します。
上記方法で成功した方がいらっしゃれば設定値など詳しく教えていただきたいです。

5. Teamsのアプリ公開設定を作成して、管理者に自企業向けアプリとして公開申請
アプリ公開設定の作成には、manifest.json ファイルと192,192サイズ、32,32サイズのjpg画像データをzip形式で固めたものが必要です。
逆に言うと、それ以外は必要ありません。
manifest.jsonにはAzure bot Serviceへの接続情報や、アクセスポリシーなどの情報を入力します。
フォーマットに従って手打ちするのもよいですが、ものすごく手間なのでツールを利用しましょう。
紹介するのは*AppStudio*です。
こちらは、manifest.jsonの入力項目や用意すべき画像をフォーム形式で入力でき、更にはデバッグ・管理者への申請などもできる便利なアプリです。
![AppStudioの紹介](画像\17.TeamsのアプリタブからAppStudioを入手する.png)
今回はbotアプリの新規作成のため、新規作成を選びましょう。
![アプリの新規作成](画像\18.新規作成を押す.png)
そこから先は、必要な入力項目を入力します。* マークがついている項目は必須項目です。
3 Finish の一番下 *Test and distribute* を開くと左側には入力内容でできることが、右側には入力チェックで引っかかった内容が表示されます。
 ![入力内容で何かするならここ](画像\補足_4_入力内容の確認.png)
この画面で入力チェックが通るまで項目を追加・変更するのも一興ではありますが、それよりも効率的な方法を発見しました。こちらのリンクです。
https://dev.teams.microsoft.com/appvalidation.html
このリンクは、teamsアプリの入力チェックと同等のものをweb上で行えます。しかも、視認性はWeb版の方が上です。
利用方法は、*Upload manifest package* に manifest.json と 192,192サイズ、32,32サイズのjpg画像をzip化したもの = アプリ公開に必要な設定フォルダをアップロードするだけ。
![入力チェックのWeb版](画像\補足_5_入力チェックWEB版.png)
![最強だと思う](画像\補足_6_入力チェックWEB版が最強.png)
Teams アプリの*App Studio*で大まかな入力を済ませてから*Download* ボタンを押下してzipファイルを入手。web版の入力チェックを利用して修正箇所を把握、修正すれば、公開ができるmanifestの設定が比較的簡単に作れると思われます。

以上がお役に立てそうな情報になります。以下の文章は失敗録になるため、情報としての価値は低いものになります。

5. Teamsのアプリ公開設定を作成して、管理者に自企業向けアプリとして公開申請
6. 管理者サイトで自企業向けアプリとして承認＆公開
7. Teamsで公開されたアプリをインストール

入力チェックを通し、*Publish*　その後上記手順を踏んでインストールを行った結果がこれです。 
![どうしてこうなった](画像\34.問題が発生した。なぜ.png)

# どうしてこうなった
なんでぇ..............

原因を分析するならば、こうですかね。
* 入力チェック以外の非機能的な要件を満たしていない可能性
* エラー内容が*問題が発生しました* ノンコーディングにこだわった結果? とにかく致命的な情報不足(詳細キボンヌ)
* 圧倒的仕様把握不足により、上記問題に対処できない

そもそも、自企業向けアプリとして公開する箇所は正直言ってノリです。マニフェスト書いて公開するだけじゃないの...? と必死に資料を探しましたが成果物はWeb版の入力チェックサイトだけでした。
https://dev.teams.microsoft.com/appvalidation.html　

Web版入力チェックサイトの大本のソースはこれ *エラーを検証する* の文字列に入力チェックサイトのURIが貼ってあります。
https://docs.microsoft.com/ja-jp/microsoftteams/platform/concepts/deploy-and-publish/apps-upload

# まとめ
* botを作成するところまではノンコーディング余裕
* 公開しようとするとうまくいかなかった。Teams以外のチャンネルでも試してみたい。
* 興味を持った方がいらっしゃれば、是非挑戦してみてください。~~そして筆者にうまく行ったパターンの情報をください~~